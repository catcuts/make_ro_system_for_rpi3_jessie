# 磁盘分区和数据迁移指南

## 磁盘分区

## 数据迁移

1. 停止 iptalk 和 mysql 运行
   `ps aux | grep iptalk | awk '{print $2}' | xargs kill -9 && service mysql stop`

2. 重新挂载只读分区为读写
   `mount -o remount,rw / && mount -o remount,rw /boot`

3. 备份文件到临时目录
   `mkdir /hyt && cp -rp /home/pi/hd/* /hyt/`

4. 卸载移动硬盘
   `umount -l /home/pi/hd`

5. 挂载第三分区
   `mount /dev/mmcblk0p3 /home/pi/hd`

6. 复制文件到第三分区
   `cp -rp /hyt/* /home/pi/hd/`

7. 更新开机启动脚本
   ```shell
    #!/bin/sh -e
    #
    # rc.local
    #
    # This script is executed at the end of each multiuser runlevel.
    # Make sure that the script will "exit 0" on success or any other
    # value on error.
    #
    # In order to enable or disable this script just change the execution
    # bits.
    #
    # By default this script does nothing.

    # Print the IP address
    _IP=$(hostname -I) || true
    if [ "$_IP" ]; then
    printf "My IP address is %s\n" "$_IP"
    fi

    mount -o remount,rw /

    {  # your 'try' block
        echo "Asynchronizing time ..." && \
            hwclock -s && \
        echo "Time asynchronized ."
    } || {  # your 'catch' block
        echo 'E R R O R - A S Y N C - T I M E'
    }

    mount -o remount,ro /

    {  # your 'try' block
        bash /home/pi/link_crontabs.sh && \
        bash /home/pi/start_iptalk_on_rpi3.sh &
    } || {  # your 'catch' block
        echo 'E R R O R - R U N N I N G - I P T A L K'
    }

    exit 0
   ```

8. 更新分区挂载配置
   - 查看移动硬盘 UUID（`blkid /dev/sda`）
   - 更新第三分区挂载点
   - 更新移动硬盘挂载点（UUID 填入硬盘 UUID）
    
    ```shell
    proc            /proc           proc    defaults             0       0
    /dev/mmcblk0p1  /boot           vfat    defaults,ro          0       2
    /dev/mmcblk0p2  /               ext4    defaults,noatime,ro  0       1
    /dev/mmcblk0p3  /home/pi/hd     ext4    defaults,noatime     0       0
    # a swapfile is not a swap partition, no line here
    #   use  dphys-swapfile swap[on|off]  for that

    UUID=2aaf6cc1-3a7c-409a-99cb-c6ac69858deb /home/pi/hd/src/data/ftp ext4 defaults,nofail 0 1

    # For Debian Jessie
    tmpfs           /tmp            tmpfs   nosuid,nodev         0       0
    tmpfs           /var/log        tmpfs   nosuid,nodev         0       0
    tmpfs           /var/tmp        tmpfs   nosuid,nodev         0       0
    ```

9.  更新计划任务
   - 新建文件 `/home/pi/log_hd.sh` 内容：
   
    ```shell
    #!/bin/bash
    DATE=$(date +%Y-%m-%d)
    TIME=$(date +%H:%M:%S)

    mountpoint=/home/pi/hd/src/data/ftp

    echo "[INFO] $DATE $TIME YOU STILL ALIVE !" >> $mountpoint/hd.log
    ```
    
   - 更新文件 `/home/pi/log_hd.sh` 模式：
     
    `chmod 777 /home/pi/log_hd.sh`
   
   - 更新计划任务：
    
    ```shell
    */1 * * * *  /home/pi/log_hd.sh
    0 0 */2 * *  /home/pi/sweep_old_iptalk_database_bkups.sh
    0 */1 * * *  /home/pi/backup_iptalk_database.sh
    ```

10. 重启：`reboot`